<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="stylesheet" href="mp.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Browser Compatibility Warning -->
    <div id="browser-warning"
        style="display:none; position:fixed; top:0; left:0; right:0; z-index:99999; background:linear-gradient(135deg, #ff6b6b, #ee5a24); color:#fff; padding:10px 40px 10px 15px; font-size:0.85rem; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
        ⚠️ このプレイヤーは <strong>Google Chrome</strong> に最適化されています。他のブラウザではほぼ機能しません。
        <button onclick="this.parentElement.style.display='none'"
            style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">×</button>
    </div>
    <script>
        // Show warning for non-Chrome browsers
        (function () {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (!isChrome) {
                document.getElementById('browser-warning').style.display = 'block';
            }
        })();
    </script>

    <div class="clock-group">
        <div id="clock-display" class="clock-display"></div>
        <button id="clock-help-btn" class="help-btn" title="Shortcuts">▼</button>
    </div>

    <div id="search-modal" class="help-modal">
        <div class="search-modal-content">
            <div class="search-bar">
                <span id="search-url-text">Searching Google...</span>
                <button onclick="document.getElementById('search-modal').classList.remove('active')"
                    class="close-btn">×</button>
            </div>
            <div
                style="flex:1; display:flex; flex-direction:column; background:#fff; align-items:center; justify-content:center; position:relative;">
                <div id="search-fallback"
                    style="display:none; position:absolute; inset:0; z-index:10; background:#fff; flex-direction:column; align-items:center; justify-content:center; gap:20px; padding:20px; text-align:center;">
                    <div style="color:#5f6368; font-size:1.1rem; font-weight:bold;">Googleで直接検索</div>
                    <button id="search-open-btn" class="btn primary-btn"
                        style="padding:15px 40px; font-size:1.2rem; border-radius:30px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
                        G 検索を開く
                    </button>
                    <div style="font-size:0.8rem; color:#999; max-width:300px;">
                        Googleは埋め込み表示を制限しているため、上のボタンから別タブで開く必要があります。
                    </div>
                </div>
                <iframe src="" id="search-iframe"
                    style="width:100%; height:100%; border:none; background:#fff;"></iframe>
            </div>
        </div>
    </div>

    <!-- Help Button / Modal -->
    <!-- Top Right Controls -->
    <div class="top-right-group">
        <input type="text" id="shortcut-input" class="shortcut-input" placeholder="Cmd→" maxlength="1">
        <button id="btn-share-link" class="help-btn" title="Share via GitHub Link"
            style="color: #3b82f6; border-color: #3b82f6;">🔗</button>
        <button id="btn-screenshot" class="help-btn" title="Take Screenshot"
            style="color: #4ade80; border-color: #4ade80;">📸</button>
        <button id="help-btn" class="help-btn" title="Shortcuts">▼</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <div id="help-modal" class="help-modal">
        <div class="help-content">
            <h3>ショートカットキー</h3>
            <ul class="help-list">
                <li><span>A / S / D / F</span> -1/36 / -1/72 / -5s / -2s</li>
                <li><span>G</span> 再生 / 一時停止</li>
                <li><span>H / J / K / L</span> +2s / +5s / +1/72 / +1/36</li>
                <li><span>Z / X / C / V</span> 最初 / 前曲 / 次曲 / 最後</li>
                <li><span>\ (¥) / ,</span> 最後へ移動 / 指定秒数へシーク</li>
                <li><span>: (;)</span> タイムスタンプ入力 (T1...:[])</li>
                <li><span>Shift + T</span> タイムスタンプ一覧表示</li>
                <li><span>Shift + [1-0, -, ^]</span> 指定位置(%)シーク (/や\併用可)</li>
                <li><span>Y [+ 1-0... / \ / ^]</span> 音量調整 (Y単体で0%)</li>
                <li><span>Esc + M</span> ショートカットモニター表示切替</li>
                <li><span>Q / E / W</span> ループ / 全体ループ / シャッフル</li>
                <li><span>[ / ]</span> 選択項目を 複製 / 削除</li>
                <li><span>B</span> 画面保存 (📸)</li>
                <li><span>U</span> URLインポート (🔗)</li>
                <li><span>↑ / ↓</span> 音量調整 (±5%)</li>
            </ul>
            <div
                style="font-size: 0.7rem; border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem; color: var(--text-muted); line-height: 1.4;">
                <strong>音量調整 (Yプレフィックス):</strong><br>
                1:1% | 2:3% | 3:5% | 4:8% | 5:15% | 6:25%<br>
                7:40% | 8:55% | 9:75% | 0:90% | -:100% | ^:-5% | \:+5%<br>
                <strong>シーク位置 (Shift + Key):</strong> 1:0% 〜 ^:91% (1/12刻み)<br>
                / 併用で+2.7%(+1/36)、\ 併用で+5.5%(+2/36) オフセット
            </div>
            <button onclick="document.getElementById('help-modal').classList.remove('active')" class="btn">閉じる</button>
        </div>
    </div>

    <!-- URL Import Modal -->
    <div id="url-import-modal" class="help-modal">
        <div class="help-content" style="max-width:500px;">
            <h3 style="margin-top:0;">🔗 URL Import</h3>
            <div
                style="background:rgba(255,100,100,0.15); border:1px solid rgba(255,100,100,0.3); border-radius:6px; padding:0.5rem; margin-bottom:1rem; font-size:0.75rem; color:#ff8888;">
                ⚠️ <strong>Chrome推奨</strong>：このプレイヤーはChrome以外のブラウザではほぼ機能しません。
            </div>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">
                共有されたURLを貼り付けてキューをインポートします。
            </p>
            <textarea id="url-import-input" class="app-input" placeholder="https://...?=[...] 形式のURLを貼り付け"
                style="width:100%; height:120px; font-family:monospace; font-size:0.8rem; resize:vertical;"></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:1rem;">
                <button id="url-import-btn" class="btn primary-btn">インポート</button>
                <button onclick="document.getElementById('url-import-modal').classList.remove('active')"
                    class="btn">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div id="share-link-modal" class="help-modal">
        <div class="help-content" style="max-width:550px;">
            <h3 style="margin-top:0;">🔗 共有リンク生成</h3>
            <div
                style="background:rgba(255,100,100,0.15); border:1px solid rgba(255,100,100,0.3); border-radius:6px; padding:0.5rem; margin-bottom:1rem; font-size:0.75rem; color:#ff8888;">
                ⚠️ <strong>Chrome推奨</strong>：このプレイヤーはChrome以外のブラウザではほぼ機能しません。
            </div>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.5rem;">
                YouTube / SoundCloud / Vimeo の曲のみ共有できます（ローカルファイルは除外）。
            </p>
            <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                <button id="share-github-btn" class="btn" style="flex:1; min-width:120px;">GitHub Pages用</button>
                <button id="share-local-btn" class="btn" style="flex:1; min-width:120px;">localhost用</button>
            </div>
            <div style="position:relative;">
                <textarea id="share-link-output" class="app-input" readonly placeholder="生成されたリンクがここに表示されます"
                    style="width:100%; height:100px; font-family:monospace; font-size:0.75rem; resize:vertical;"></textarea>
                <button id="share-copy-btn" class="btn"
                    style="position:absolute; top:5px; right:5px; padding:0.3rem 0.6rem; font-size:0.75rem;">コピー</button>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:1rem;">
                <button onclick="document.getElementById('share-link-modal').classList.remove('active')"
                    class="btn">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Held Keys Indicator (Bottom Left) -->
    <div id="held-keys-indicator"
        style="position: fixed; bottom: 15px; left: 15px; z-index: 5000; font-family: monospace; font-size: 36pt; color: #fff; background: transparent; pointer-events: none; transition: opacity 0.2s; opacity: 0; text-shadow: 2px 2px 4px #000;">
    </div>

    <!-- Lock Overlay -->
    <div id="lock-overlay" class="lock-overlay">
        <div class="lock-visual-container">
            <svg class="lock-svg" width="80" height="80">
                <circle class="lock-bg-circle" cx="40" cy="40" r="35" />
                <circle id="lock-progress-circle" class="lock-fg-circle" cx="40" cy="40" r="35" />
            </svg>
            <div class="lock-icon">🔒</div>
        </div>
    </div>

    <div class="app-container vertical-layout">
        <!-- New Order: 1. Player/Info, 2. Add Song, 3. Queue -->

        <div class="main-content">
            <!-- 1行目: Player & Info -->
            <div class="player-container">
                <div id="player-wrapper" class="video-frame">
                    <div id="youtube-player"></div>
                    <div id="soundcloud-player" style="display: none; width: 100%; height: 100%;"></div>
                    <div id="vimeo-player" style="display: none; width: 100%; height: 100%;"></div>
                </div>

                <div id="cumulative-time" class="cumulative-overlay">00:00:00</div>

                <!-- プログレスバー・オーバーレイ -->
                <div class="progress-overlay" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>

                <div class="info-group">
                    <div class="time-display">
                        <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                    </div>
                    <div class="title-row-main">
                        <select id="now-tier" class="info-input tier-select-main">
                            <option value="">Tier</option>
                            <option value="💯">💯</option>
                            <option value="＊＊＊＊＊＊">＊＊＊＊＊＊</option>
                            <option value="＊＊＊＊＊">＊＊＊＊＊</option>
                            <option value="＊＊＊＊">＊＊＊＊</option>
                            <option value="＊＊＊">＊＊＊</option>
                            <option value="＊＊">＊＊</option>
                            <option value="＊">＊</option>
                            <option value="△">△</option>
                            <option value="×">×</option>
                            <option value="-">-</option>
                            <option value="Fail">Fail</option>
                        </select>
                        <input type="text" id="now-title" class="info-input title" placeholder="Song Title">
                    </div>
                    <input type="text" id="now-author" class="info-input" placeholder="Artist">
                    <textarea id="now-memo" class="info-input" placeholder="Memo" rows="1"
                        style="color: var(--text-muted); font-size: 0.9rem; resize: vertical; min-height: 2em;"></textarea>
                    <input type="text" id="now-id" class="info-input" placeholder="Video ID / URL">
                </div>

                <!-- Row 1: Z X C V -->
                <div class="controls-row">
                    <button class="btn" id="btn-first" title="Top">Top<small>Z</small></button>
                    <button class="btn" id="btn-prev" title="Prev">⏮<small>X</small></button>
                    <button class="btn" id="btn-next" title="Next">⏭<small>C</small></button>
                    <button class="btn" id="btn-last" title="End">End<small>V</small></button>
                </div>

                <!-- Row 2: A S D F G H J K L -->
                <div class="controls-row all-controls">
                    <button class="btn" id="btn-seek-back30" title="-1/36">|←<small>A</small></button>
                    <button class="btn" id="btn-seek-back10" title="-1/72">●←<small>S</small></button>
                    <button class="btn" id="btn-seek-back5" title="-5s">-5s<small>D</small></button>
                    <button class="btn" id="btn-seek-back" title="-2s">-2s<small>F</small></button>
                    <button class="btn" id="btn-pause" title="Play/Pause">▶/||<small>G</small></button>
                    <button class="btn" id="btn-seek-fwd" title="+2s">+2s<small>H</small></button>
                    <button class="btn" id="btn-seek-fwd5" title="+5s">+5s<small>J</small></button>
                    <button class="btn" id="btn-seek-fwd10" title="+1/72">→●<small>K</small></button>
                    <button class="btn" id="btn-seek-fwd30" title="+1/36">→|<small>L</small></button>
                </div>

                <!-- Row 3: Loop/Shuf/Copy/Del/IO/Lock -->
                <div class="controls-row io-controls">
                    <div class="btn-group"
                        style="display: flex; gap: 0; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative;">
                        <div
                            style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 0.55rem; color: var(--text-muted); pointer-events: none; z-index: 10;">
                            Loop</div>
                        <button class="btn" id="btn-loop"
                            style="border:none; border-radius:0; border-right:1px solid var(--border); min-width:50px; padding-top: 0.8rem;">One<small>Q</small></button>
                        <button class="btn" id="btn-queue-loop"
                            style="border:none; border-radius:0; min-width:55px; padding-top: 0.8rem;">Queue<small>E</small></button>
                    </div>
                    <button class="btn" id="btn-shuffle">Shuf<small>W</small></button>
                    <button class="btn" id="btn-copy-sel" title="Copy Selected">Copy<small>[</small></button>
                    <button class="btn" id="btn-delete" style="color: var(--accent);">Del<small>]</small></button>

                    <select id="preset-select" class="btn preset-select" style="min-width: 100px;">
                        <option value="">Presets</option>
                        <option value="2345667.txt">2345667</option>
                    </select>
                    <button id="btn-export" class="btn">Export</button>
                    <button id="btn-import" class="btn">Import</button>
                    <button id="btn-url-import" class="btn" style="color:#3b82f6; border-color:#3b82f6;"
                        title="URL Import">URL<small>U</small></button>
                    <button id="btn-lock" class="btn lock-btn">
                        <div class="lock-visual-container mini">
                            <svg class="lock-svg" width="40" height="40">
                                <circle class="lock-bg-circle" cx="20" cy="20" r="18" />
                                <circle id="lock-btn-progress-circle" class="lock-fg-circle" cx="20" cy="20" r="18" />
                            </svg>
                            <div class="lock-icon">🔒</div>
                        </div>
                        <span class="lock-text">Lock</span>
                    </button>
                </div>

                <!-- 音響設定: 音量調整 -->
                <div class="audio-effects add-section"
                    style="padding: 0.75rem; border-top: 1px solid var(--border); margin-top: 1rem;">
                    <div class="audio-row" style="display: flex; align-items: center; gap: 1rem;">
                        <label style="font-size: 0.85rem; color: var(--text-muted); min-width: 80px;">🔉
                            Volume</label>
                        <input type="range" id="volume-slider" min="0" max="100" step="1" value="100"
                            style="flex: 1; accent-color: var(--primary);">
                        <input type="number" id="volume-input" min="0" max="100" value="100"
                            style="width: 50px; background: transparent; border: 1px solid var(--border); color: var(--primary-light); text-align: center; border-radius: 4px; font-family: monospace;">
                        <span style="font-size: 0.85rem; color: var(--primary-light);">%</span>
                    </div>
                </div>
            </div>

            <!-- Add New Song (Add to Queueを大きく) -->
            <div class="add-section">
                <h3
                    style="margin:0 0 0.5rem 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    Add Song
                    <button id="btn-recommend-vocaloid" class="btn small-btn"
                        style="font-size: 0.75rem; border-color: #00ffd5; background: linear-gradient(135deg, #008080, #00aaaa) !important; color: #fff;">💙
                        Vocaloid</button>
                </h3>
                <div class="input-row">
                    <div style="flex:1; display:flex; flex-direction:column; gap:0.5rem;">
                        <input type="text" id="add-url" class="app-input" placeholder="YouTube/SoundCloud/Vimeo URL">
                        <div class="input-row">
                            <input type="text" id="add-title" class="app-input add-input-large" placeholder="Song Title"
                                style="flex: 2; min-width: 150px;">
                            <input type="text" id="add-author" class="app-input add-input-large" placeholder="Artist"
                                style="flex: 1; min-width: 100px;">
                            <textarea id="add-memo" class="app-input add-input-large" placeholder="Memo" rows="1"
                                style="flex: 1; min-width: 100px; resize: vertical; min-height: 2em; box-sizing: border-box;"></textarea>
                            <select id="add-tier" class="app-input tier-select">
                                <option value="">Tier</option>
                                <option value="💯">💯</option>
                                <option value="＊＊＊＊＊＊">＊＊＊＊＊＊</option>
                                <option value="＊＊＊＊＊">＊＊＊＊＊</option>
                                <option value="＊＊＊＊">＊＊＊＊</option>
                                <option value="＊＊＊">＊＊＊</option>
                                <option value="＊＊">＊＊</option>
                                <option value="＊">＊</option>
                                <option value="△">△</option>
                                <option value="×">×</option>
                                <option value="-">-</option>
                                <option value="Fail">Fail</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.5rem;">
                        <button id="btn-add" class="btn primary-btn big-add-btn" style="flex:1;">Add to
                            Queue<br>([)</button>
                        <button id="btn-load-file" class="btn orange-btn" style="font-size:0.8rem; padding:0.4rem;">Load
                            File</button>
                    </div>
                </div>
            </div>

            <!-- 内部保存用（非表示） -->
            <div style="display: none;">
                <input type="number" id="sleep-min">
            </div>
        </div>

        <!-- Queue Section -->
        <div class="right-panel">
            <div class="queue-header">
                <div style="display: flex; flex-direction: column;">
                    <strong>Queue</strong>
                    <span id="queue-status" style="font-size: 0.7rem; opacity: 0.6;">0 / 32767</span>
                </div>
                <div class="header-actions">
                    <select id="sort-mode" class="btn small-btn sort-select"
                        style="padding: 0.2rem 0.4rem; min-width: 70px;">
                        <option value="manual">手動</option>
                        <option value="tier">Tier順</option>
                    </select>
                    <button id="btn-dedupe" class="btn orange-btn small-btn">Dedupe</button>
                    <button id="btn-copy-sel-q" class="btn primary-btn small-btn">Copy</button>
                    <button id="btn-delete-q" class="btn red-btn small-btn">Delete</button>
                    <button id="btn-clear" class="btn red-btn small-btn">Clear</button>
                </div>
            </div>
            <ul id="queue-list" class="queue-list"></ul>
            <div class="queue-footer">
                Drag: Reorder | 📋: Copy | 🗑️: Delete
            </div>
        </div>
    </div>

    <!-- Modal for File Import -->
    <input type="file" id="file-input" style="display: none;"
        accept=".json,.txt,.mp3,.wav,.m4a,.mp4,.mkv,.webp,.gif,.png,.jpeg,.jpg,.svg">

    <script src="https://w.soundcloud.com/player/api.js"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="mp.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
</body>

</html>